/*!
 * RCRS Web Viewer v0.2.1602593430189
 * https://github.com/roborescue/rcrs-web-viewer
 * 
 * Released under the BSD-3-Clause license
 * https://opensource.org/licenses/BSD-3-Clause
 *
 * Date: 2020-10-13T12:50:30.189Z (Tue, 13 Oct 2020 12:50:30 GMT)
 */
const DRAW_BORDER_LINE=!0,DRAW_BORDER_LINE_WIDTH=50,DRAW_AGENT_CIRCLE_RADIUS=1500,DRAW_CIVILIAN_CIRCLE_RADIUS=1200,DRAW_AGENT_CIRCLE_CUTS=15,COMMAND_EXTINGUISH_LINE_WIDTH=50,COMMAND_MOVEHISTORY_LINE_WIDTH=50,COMMAND_CLEARAREA_LINE_WIDTH=50,COMMAND_CLEARAREA_CLEARWIDTH=2e3,COMMAND_CLEARAREA_CLEARLENGTH=1e4,COMMAND_RESCUE_MARGIN=300,COMMAND_RESCUE_CUTS=13,ENTITY_NAME_CIVILIAN="Civilian",ENTITY_NAME_AMBULANCE_TEAM="Ambulance team",ENTITY_NAME_FIRE_BRIGADE="Fire brigade",ENTITY_NAME_POLICE_FORCE="Police force",ENTITY_NAME_BLOCKADE="Blockade",ENTITY_NAME_HYDRANT="Hydrant",ENTITY_NAME_ROAD="Road",ENTITY_NAME_REFUGE="Refuge",ENTITY_NAME_BUILDING="Building",ENTITY_NAME_GAS_STATION="Gas Station",ENTITY_NAME_AMBULANCE_CENTRE="Ambulance centre",ENTITY_NAME_FIRE_STATION="Fire station",ENTITY_NAME_POLICE_OFFICE="Police office",ENTITY_ATTR_ID="Id",ENTITY_ATTR_ENTITY_NAME="EntityName",ENTITY_ATTR_HP="urn:rescuecore2.standard:property:hp",ENTITY_ATTR_FIERYNESS="urn:rescuecore2.standard:property:fieryness",ENTITY_ATTR_APEXES="urn:rescuecore2.standard:property:apexes",ENTITY_ATTR_POSITION="urn:rescuecore2.standard:property:position",ENTITY_ATTR_POSITIONHISTORY="urn:rescuecore2.standard:property:positionhistory",COMMAND_EXTINGUISH="urn:rescuecore2.standard:message:extinguish",COMMAND_CLEAR="urn:rescuecore2.standard:message:clear",COMMAND_CLEARAREA="urn:rescuecore2.standard:message:clear_area",COMMAND_RESCUE="urn:rescuecore2.standard:message:rescue",SETTING_ICON_RADIUS=7e3,WORKER_COMMAND_LOADDATA="load_data",WORKER_COMMAND_IMPORTSCRIPT="import_script",WORKER_COMMAND_SETICONS="sync_icons",WORKER_COMMAND_PROGRESSREPORT="progress_report",WORKER_COMMAND_MAPBOUNDS="map_bounds",WORKER_COMMAND_CYCLEDATA="cycle_data",WORKER_COMMAND_INFO="info",WORKER_COMMAND_BASEDATA="base_data",HUMAN_HP_MAX=1e4,HUMAN_HP_INJURED=7500,HUMAN_HP_CRITICAL=1e3,COLOR_HUMAN_TYPE_CIVILIAN=[0,1,0],COLOR_HUMAN_TYPE_FIRE_BRIGADE=[1,0,0],COLOR_HUMAN_TYPE_AMBULANCE_TEAM=[1,1,1],COLOR_HUMAN_TYPE_POLICE_FORCE=[0,0,1],COLOR_HUMAN_TYPE_DEAD=[0,0,0],COLOR_ROAD_DEFAULT=[.72,.72,.72],COLOR_BLOCKADE_DEFAULT=[0,0,0],COLOR_BORDER_DEFAULT=[0,0,0],COLOR_COMMAND_EXTINGUISH=[.2,.2,1],COLOR_COMMAND_MOVEHISTORY=[1,0,0],COLOR_COMMAND_CLEARAREA=[.4,.4,1],COLOR_COMMAND_RESCUE=[.9,.9,.9],COLOR_BUILDING_FIERYNESS_UNBURNT=[.52,.52,.52],COLOR_BUILDING_FIERYNESS_HEATING=[.69,.69,.21],COLOR_BUILDING_FIERYNESS_BURNING=[.8,.47,.19],COLOR_BUILDING_FIERYNESS_INFERNO=[.62,.2,.2],COLOR_BUILDING_FIERYNESS_WATER_DAMAGE=[.19,.47,.51],COLOR_BUILDING_FIERYNESS_MINOR_DAMAGE=[.39,.54,.82],COLOR_BUILDING_FIERYNESS_MODERATE_DAMAGE=[.39,.27,.74],COLOR_BUILDING_FIERYNESS_SEVERE_DAMAGE=[.31,.23,.54],COLOR_BUILDING_FIERYNESS_BURNT_OUT=[0,0,0];function GameMaker(e,t=(()=>{})){this.histories=[],this.infos=[],this.currentCycle=0,this.lastLoadedCycle=-1,this.baseHistorian=new Historian,this.setBaseHistorian=function(e){this.baseHistorian=e},this.drawCycle=function(e=this.currentCycle){this.canvasDrawer.drawer.historyManager.historians=[this.baseHistorian,this.histories[e]],this.canvasDrawer.drawer.redraw()},this.getScore=function(e){return this.infos[e].Score},this.getLastCycleNumber=function(){return this.getInfo().lastCycle},this.getLastLoadedCycleNumber=function(){return this.lastLoadedCycle},this.setCorrectScaleAndTranslation=function(e,t,a,s){let r=Math.abs(a-e),o=Math.abs(s-t),n=this.canvasDrawer.drawer.gl.canvas,i=n.width,l=n.height,c=i/r,_=l/o,C=c<_?c:_;C*=.9,this.canvasDrawer.drawer.setScale(C),this.canvasDrawer.drawer.setTextureScale(C);let E=(i-C*r)/2,d=(l-C*o)/2;this.canvasDrawer.drawer.setTextureTranslation(E,d+o*C),this.canvasDrawer.drawer.updateTranslation(E,d+o*C)},this.loadCycle=function(e,t,a={}){this.histories[e]=t,this.infos[e]=a,e>this.lastLoadedCycle&&(this.lastLoadedCycle=e)},this.getInfo=function(){return this.infoObject},this.setInfo=function(e){this.infoObject=e,this.allCycles=e.lastCycle},this.constructor=function(e,t){this.canvasDrawer=e,this.allCycles=0,this.infoObject={},this.positionMaker=new PositionMaker,this.canvasDrawer.drawer.enableBlending(),t("Loading game entities ...",90,!1)},this.constructor(e,t)}function UIController(e){this.loadDataFromInfo=function(e,t){return e in this.info?this.info[e]:t},this.start=function(){!1===this.isPlaying&&(this.isPlaying=setInterval(()=>{this.nextCycle()||this.pause()},this.playingDelay),this.reloadControllPanel())},this.pause=function(){!1!==this.isPlaying&&clearInterval(this.isPlaying),this.isPlaying=!1,this.reloadControllPanel()},this.reset=function(){this.pause(),this.setCycle(0)},this.setLoadedCycle=function(e){this.lastLoadedCycle<e&&(this.lastLoadedCycle=e,this.reloadControllPanel())},this.reloadControllPanel=function(){!1!==this.isPlaying||this.currentCycle>=this.lastLoadedCycle?this.buttons.start.prop("disabled",!0):this.buttons.start.prop("disabled",!1),0==this.currentCycle?this.buttons.back.prop("disabled",!0):this.buttons.back.prop("disabled",!1),this.currentCycle>=this.lastLoadedCycle?this.buttons.next.prop("disabled",!0):this.buttons.next.prop("disabled",!1)},this.setCycle=function(e){$("#cycle-number").html(e+" / "+this.lastCycle),$("#team-score-field").html(this.getScore(e)),this.currentCycle=e,this.showCycle(e),this.reloadControllPanel()},this.nextCycle=function(){return!(this.currentCycle>=this.lastLoadedCycle)&&(this.setCycle(this.currentCycle+1),!0)},this.prevCycle=function(){return!(this.currentCycle<=0)&&(this.setCycle(this.currentCycle-1),!0)},this.buttons={next:$("#controll-next"),back:$("#controll-back"),start:$("#controll-start"),pause:$("#controll-pause"),reset:$("#controll-reset")},this.info=e,this.currentCycle=0,this.isPlaying=!1,this.lastLoadedCycle=-1,this.getScore=this.loadDataFromInfo("getScore",e=>-1),this.showCycle=this.loadDataFromInfo("showCycle",e=>{}),this.lastCycle=this.loadDataFromInfo("lastCycle",0),this.playingDelay=this.loadDataFromInfo("playingDelay",1500);let t=this.loadDataFromInfo("teamName","Unknown"),a=this.loadDataFromInfo("mapName","Unknown");$("#team-name-field").html(t),$("#map-name-field").html(a),this.buttons.next.click(()=>{uiController.nextCycle()}),this.buttons.back.click(()=>{uiController.prevCycle()}),this.buttons.start.click(()=>{uiController.start()}),this.buttons.pause.click(()=>{uiController.pause()}),this.buttons.reset.click(()=>{uiController.reset()})}var gameMaker,uiController,canvasDrawer,worker;function resizeCanvasToFit(){let e=document.getElementById(CANVAS_ID);e.width=e.clientWidth,e.height=e.clientHeight}function showError(e){$(".modal").not(ERROR_MODAL).modal("hide");let t="<li>"+e+"</li>";$("#error-message").append(t),$(ERROR_MODAL).modal("show")}function showLoadingModal(){$(ERROR_MODAL).data()["bs.modal"]&&$(ERROR_MODAL).data()["bs.modal"]._isShown||$(LOADING_MODAL).modal("show")}function UISetup(e){let t=e.getInfo();uiController=new UIController({teamName:t.TeamName,mapName:t.MapName,showCycle:t=>{e.drawCycle(t)},getScore:t=>e.getScore(t),lastCycle:e.getLastCycleNumber(),playingDelay:PLAYING_DELAY})}function setProgressBarSize(e,t=100){let a=100*e/t;$(".progress-bar").css("width",a+"%").attr("aria-valuenow",a)}function loadFunction(e,t=-1,a=!1){console.log(e),document.getElementById("status").innerText=e,t>0&&setProgressBarSize(t),a&&($(LOADING_MODAL).modal("hide"),setTimeout((function(){$(LOADING_MODAL).modal("hide")}),1e3))}function workerMassageParser(e){switch(e.data.command){case"progress_report":loadFunction(e.data.text,e.data.percent);break;case"map_bounds":gameMaker.setCorrectScaleAndTranslation(e.data.minX,e.data.minY,e.data.maxX,e.data.maxY);break;case"base_data":let t=new Historian;t.memo=e.data.data.memo,t.keys=e.data.data.keys,gameMaker.setBaseHistorian(t);break;case"cycle_data":let a=new Historian;a.memo=e.data.data.memo,a.keys=e.data.data.keys;let s=e.data.cycle,r=e.data.info;gameMaker.loadCycle(s,a,r),uiController.setLoadedCycle(s),0==s&&uiController.setCycle(0),2==s&&loadFunction("Completed.",100,!0);break;case"info":gameMaker.setInfo(e.data.info),UISetup(gameMaker)}}function parseShowJLOGFile(e){loadFunction("Map file downloaded ...",80),e=(e=(e=e.split("\n")).filter(e=>e.trim().length>0)).map(e=>JSON.parse(e)),loadFunction("Map file loaded ...",82);let t=[ICONS_POLICE_OFFICE,ICONS_AMBULANCE_CENTRE,ICONS_FIRE_STATION,ICONS_REFUGE,ICONS_GAS_STATION,ICONS_HYDRANT];canvasDrawer.loadTextures(t,t=>{loadFunction("Texture files loaded ...",90),gameMaker=new GameMaker(canvasDrawer,loadFunction),worker.postMessage({command:"load_data",data:e,textures:t})})}function main(){if(resizeCanvasToFit(),!window.Worker)return void showError("WebWorker is not supported.");showLoadingModal(),canvasDrawer=new CanvasDrawer({id:CANVAS_ID,errorFunction:()=>showError("WebGL is not supported."),cartographer:!0,zoominrate:1.15,zoomoutrate:.85}),window.onresize=function(){resizeCanvasToFit(),canvasDrawer.drawer.refitWebglToCanvas()},(worker=new Worker(WORKER_FILE)).onmessage=workerMassageParser;let e=[SCRIPT_EARCUT,SCRIPT_CANVASDRAWER];for(let t in e)worker.postMessage({command:"import_script",script:e[t]});worker.postMessage({command:"sync_icons",icons:{po:ICONS_POLICE_OFFICE,ac:ICONS_AMBULANCE_CENTRE,fs:ICONS_FIRE_STATION,rf:ICONS_REFUGE,gs:ICONS_GAS_STATION,hy:ICONS_HYDRANT}}),loadFunction("Downloading cycles data ...",0);var t=new XMLHttpRequest;t.responseType="arraybuffer",$.ajax(JLOG_ZIP_FILE,{xhr:function(){return t},progress:function(e){if(e.lengthComputable){let t=Math.round(80*e.loaded/e.total);loadFunction("Downloading cycles data ... ("+t+"%)",t)}}}).done(e=>{console.log(e),(new JSZip).loadAsync(e).then((function(e){e.file(JLOG_INNER_FILE).async("string").then((function(e){parseShowJLOGFile(e)}))}))})}
